flowchart TB
    AUTH_IN[Authenticated Request] --> API_GW[API Gateway]
    
    subgraph "Conversation Service"
        CONV_API[API Layer]
        CONV_CQRS{CQRS Router}
        CONV_QUERY[Query Handler]
        CONV_CMD[Command Handler]
        CONV_DATA[Data Layer]
        
        CONV_API --> CONV_CQRS
        CONV_CQRS --> CONV_QUERY
        CONV_CQRS --> CONV_CMD
        CONV_QUERY --> CONV_DATA
        CONV_CMD --> CONV_DATA
    end
    
    subgraph "Workflow Service"
        WF_API[API Layer]
        WF_CQRS{CQRS Router}
        WF_QUERY[Query Handler]
        WF_CMD[Command Handler]
        WF_DATA[Data Layer]
        
        WF_API --> WF_CQRS
        WF_CQRS --> WF_QUERY
        WF_CQRS --> WF_CMD
        WF_QUERY --> WF_DATA
        WF_CMD --> WF_DATA
    end
    
    subgraph "Agent Service"
        AGENT_API[API Layer]
        AGENT_CQRS{CQRS Router}
        AGENT_QUERY[Query Handler]
        AGENT_CMD[Command Handler]
        AGENT_DATA[Data Layer]
        
        AGENT_API --> AGENT_CQRS
        AGENT_CQRS --> AGENT_QUERY
        AGENT_CQRS --> AGENT_CMD
        AGENT_QUERY --> AGENT_DATA
        AGENT_CMD --> AGENT_DATA
    end
    
    subgraph "Platform Service"
        PLATFORM_API[API Layer]
        PLATFORM_CQRS{CQRS Router}
        PLATFORM_QUERY[Query Handler]
        PLATFORM_CMD[Command Handler]
        PLATFORM_DATA[Data Layer]
        
        PLATFORM_API --> PLATFORM_CQRS
        PLATFORM_CQRS --> PLATFORM_QUERY
        PLATFORM_CQRS --> PLATFORM_CMD
        PLATFORM_QUERY --> PLATFORM_DATA
        PLATFORM_CMD --> PLATFORM_DATA
    end
    
    API_GW --> CONV_API
    API_GW --> WF_API
    API_GW --> AGENT_API
    API_GW --> PLATFORM_API
    
    subgraph "Infrastructure Controllers/Operators"
        subgraph "Event Bus Controller"
            EB_CTRL[Pulsar Operator]
            EB_API[Pulsar API<br/>Per-Tenant Topics]
        end
        
        subgraph "Database Controller"
            DB_CTRL[PostgreSQL Operator]
            DB_API[Database API<br/>Per-Service Databases]
        end
        
        subgraph "Cache Controller"
            CACHE_CTRL[Redis Operator]
            CACHE_API[Cache API<br/>Per-Service Instances]
        end
        
        subgraph "Storage Controller"
            STORAGE_CTRL[Storage Operator]
            STORAGE_API[Volume API<br/>Per-Service PVCs]
        end
        
        subgraph "LLM Controller"
            LLM_CTRL[LLM Operator]
            LLM_API[Model API<br/>Shared GPU Pool]
        end
    end
    
    subgraph "Infrastructure Access (Data Layers → Operator APIs)"
        CONV_DATA --> DB_API
        CONV_DATA --> CACHE_API
        CONV_DATA --> STORAGE_API
        
        WF_DATA --> DB_API
        WF_DATA --> CACHE_API
        WF_DATA --> STORAGE_API
        
        AGENT_DATA --> DB_API
        AGENT_DATA --> CACHE_API
        AGENT_DATA --> LLM_API
        
        PLATFORM_DATA --> DB_API
        PLATFORM_DATA --> CACHE_API
    end
    
    subgraph "Inter-Service Events (Command Handlers ↔ Event Bus)"
        CONV_CMD --> EB_API
        WF_CMD --> EB_API
        AGENT_CMD --> EB_API
        PLATFORM_CMD --> EB_API
        
        EB_API --> CONV_CMD
        EB_API --> WF_CMD
        EB_API --> AGENT_CMD
        EB_API --> PLATFORM_CMD
    end
    
    style AUTH_IN fill:#e1f5fe
    style API_GW fill:#f3e5f5
    style CONV_CQRS fill:#e8f5e8
    style WF_CQRS fill:#e8f5e8
    style AGENT_CQRS fill:#e8f5e8
    style PLATFORM_CQRS fill:#e8f5e8
    style EB_API fill:#fce4ec
    style DB_API fill:#e3f2fd
    style CACHE_API fill:#f3e5f5
    style LLM_API fill:#fff3e0 